<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weekly Crop Guidance</title>
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4a7c59;
      --primary-light: #e8f5e9;
      --secondary: #f3c623;
      --text: #2d3748;
      --text-light: #718096;
      --border: #e2e8f0;
      --card-bg: #ffffff;
      --success: #38a169;
      --warning: #dd6b20;
      --danger: #e53e3e;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7fafc;
      color: var(--text);
      line-height: 1.6;
    }
    
    .guidance-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    
    .guidance-header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 2rem;
      background: linear-gradient(135deg, #4a7c59, #28a745);
      border-radius: var(--radius);
      color: white;
      box-shadow: var(--shadow);
    }
    
    .guidance-header h1 {
      font-size: 2.25rem;
      margin-bottom: 1rem;
    }
    
    .week-selector {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .week-nav {
      display: flex;
      gap: 0.75rem;
    }
    
    .week-btn {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border);
      background: white;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .week-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .week-info {
      text-align: center;
    }
    
    .week-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    
    .week-subtitle {
      color: var(--text-light);
      margin-top: 0.25rem;
    }
    
    .guidance-content {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .section-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    .section-header {
      background: var(--primary);
      color: white;
      padding: 1rem 1.5rem;
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .section-content {
      padding: 1.5rem;
    }
    
    .video-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.25rem;
      margin-top: 1rem;
    }
    
    .video-item {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .video-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .video-thumbnail {
      width: 100%;
      height: 180px;
      background: #f0f4f8;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: #cbd5e0;
    }
    
    .video-info {
      padding: 1rem;
    }
    
    .video-title {
      font-weight: 600;
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
    }
    
    .video-meta {
      font-size: 0.85rem;
      color: var(--text-light);
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .no-data {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-light);
    }
    
    @media (max-width: 1024px) {
      .guidance-content {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        grid-row: 1;
      }
    }
    
    @media (max-width: 768px) {
      .week-selector {
        flex-direction: column;
        text-align: center;
      }
      
      .week-nav {
        width: 100%;
        justify-content: space-between;
      }
      
      .video-list {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <nav class="nav">
      <a href="/index.html" class="logo">üå± Weekly Crop Guidance</a>
      <ul class="nav-links">
        <li><a href="/index.html">üè† Home</a></li>
        <li><a href="/my-tasks.html">üìã My Tasks</a></li>
        <li><a href="#" onclick="logoutAndRefresh()">Logout</a></li>
      </ul>
    </nav>
  </header>

  <div class="guidance-container">
    <!-- Guidance Header -->
    <div class="guidance-header">
      <h1>üå± Weekly Crop Guidance</h1>
      <p id="cropInfo">Select a crop to view detailed weekly guidance</p>
      <div style="margin-top: 1.5rem;">
        <a href="/weekly-guidance-enhanced.html" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 0.6rem 1.25rem; border-radius: 8px; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s;">
          üöÄ Enhanced Progress Tracking
        </a>
      </div>
    </div>

    <!-- Week Selector -->
    <div class="week-selector" id="weekSelector" style="display: none;">
      <div class="week-nav">
        <button class="week-btn" id="prevWeekBtn">‚Üê Previous</button>
        <button class="week-btn" id="nextWeekBtn">Next ‚Üí</button>
      </div>
      <div class="week-info">
        <div class="week-title" id="weekTitle">Week 1</div>
        <div class="week-subtitle" id="weekSubtitle">Nursery Preparation</div>
      </div>
      <div class="week-nav">
        <button class="week-btn" id="jumpToWeekBtn">Jump to Week</button>
      </div>
    </div>

    <!-- Guidance Content -->
    <div class="guidance-content" id="guidanceContent" style="display: none;">
      <!-- Main Content -->
      <div class="main-content">
        <!-- Weekly Tasks -->
        <div class="section-card">
          <div class="section-header">
            üìã Weekly Tasks
          </div>
          <div class="section-content">
            <div id="weeklyTasks" class="task-list">
              <!-- Tasks will be loaded here -->
              <div class="no-data">Loading tasks...</div>
            </div>
          </div>
        </div>

        <!-- Videos -->
        <div class="section-card">
          <div class="section-header">
            üé• Helpful Videos
          </div>
          <div class="section-content">
            <div id="videoList" class="video-list">
              <!-- Videos will be loaded here -->
              <div class="no-data">Loading videos...</div>
            </div>
          </div>
        </div>

        <!-- Crop Stages -->
        <div class="section-card">
          <div class="section-header">
            üå± Growth Stages
          </div>
          <div class="section-content">
            <div id="cropStages" class="crop-stages">
              <div class="no-data">Loading growth stages...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Progress Summary -->
        <div class="section-card">
          <div class="section-header">
            üìä Progress Summary
          </div>
          <div class="section-content">
            <div id="progressSummary">
              <div class="no-data">Loading progress...</div>
            </div>
          </div>
        </div>

        <!-- Fertilizers & Pesticides -->
        <div class="section-card">
          <div class="section-header">
            üåø Fertilizers & Pesticides
          </div>
          <div class="section-content">
            <div id="fertilizersPesticides">
              <div class="no-data">Loading fertilizers and pesticides...</div>
            </div>
          </div>
        </div>
        
        <!-- Growing Tips -->
        <div class="section-card" id="tipsSection" style="display: none;">
          <div class="section-header">
            üí° Growing Tips
          </div>
          <div class="section-content">
            <div id="tipsContent">
              <div class="no-data">Loading tips...</div>
            </div>
          </div>
        </div>
        
        <!-- Weather Recommendations -->
        <div class="section-card" id="weatherSection" style="display: none;">
          <div class="section-header">
            üå§Ô∏è Weather Recommendations
          </div>
          <div class="section-content">
            <div id="weatherContent">
              <div class="no-data">Loading weather recommendations...</div>
            </div>
          </div>
        </div>
        
        <!-- Task Dependencies -->
        <div class="section-card" id="dependenciesSection" style="display: none;">
          <div class="section-header">
            üîó Task Dependencies
          </div>
          <div class="section-content">
            <div id="dependenciesContent">
              <div class="no-data">Loading task dependencies...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No Data State -->
    <div class="no-data" id="noDataState">
      <h3>No Active Crops</h3>
      <p>You don't have any active crop monitoring sessions.</p>
      <a href="/index.html" class="btn btn-primary">Start Growing a Crop</a>
    </div>
  </div>

  <!-- Video Modal -->
  <div id="videoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="videoModalTitle">Video</h2>
        <span class="close" onclick="closeVideoModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="video-container" id="videoContainer">
          <!-- Video will be embedded here -->
        </div>
        <div id="videoDescription"></div>
      </div>
    </div>
  </div>

  <script>
    let currentCrop = null;
    let currentWeek = 1;
    let maxWeeks = 20;
    let activeCrops = [];
    let currentSessionId = null;
    let availableWeeks = []; // Array of weeks that have tasks
    let currentWeekIndex = 0; // Index in availableWeeks array

    // Check authentication
    async function ensureAuth() {
      try {
        const response = await fetch('/api/me');
        const me = await response.json();
        if (!me.authenticated) {
          alert('Please login to access weekly guidance.');
          window.location.href = '/login.html';
          return false;
        }
        return true;
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/login.html';
        return false;
      }
    }

    // Load active crops
    async function loadActiveCrops() {
      try {
        const response = await fetch('/api/active-crops');
        if (response.ok) {
          const data = await response.json();
          activeCrops = data.active_crops;
          
          if (activeCrops.length === 0) {
            document.getElementById('noDataState').style.display = 'block';
            return;
          }
          
          // Use the first active crop
          currentCrop = activeCrops[0];
          currentSessionId = currentCrop.id;
          maxWeeks = currentCrop.total_weeks;
          currentWeek = currentCrop.current_week;
          
          document.getElementById('cropInfo').textContent = 
            `${currentCrop.crop_name} - ${currentCrop.land_size} acres - ${currentCrop.soil_type}`;
          
          document.getElementById('weekSelector').style.display = 'flex';
          document.getElementById('guidanceContent').style.display = 'grid';
          document.getElementById('noDataState').style.display = 'none';
          
          // Load available weeks first
          await loadAvailableWeeks();
          loadWeeklyGuidance();
        } else {
          throw new Error('Failed to load active crops');
        }
      } catch (error) {
        console.error('Error loading active crops:', error);
        document.getElementById('noDataState').style.display = 'block';
      }
    }

    // Load available weeks (weeks that have tasks)
    async function loadAvailableWeeks() {
      if (!currentCrop) return;
      
      try {
        const response = await fetch(`/api/crops/${currentCrop.crop_id}/available-weeks`);
        if (response.ok) {
          const data = await response.json();
          availableWeeks = data.weeks || [];
          
          if (availableWeeks.length === 0) {
            // Fallback to all weeks if no specific weeks found
            availableWeeks = Array.from({length: maxWeeks}, (_, i) => i + 1);
          }
          
          // Find current week in available weeks or use first
          currentWeekIndex = availableWeeks.indexOf(currentWeek);
          if (currentWeekIndex === -1) {
            currentWeekIndex = 0;
            currentWeek = availableWeeks[0];
          }
        }
      } catch (error) {
        console.error('Error loading available weeks:', error);
        // Fallback to all weeks
        availableWeeks = Array.from({length: maxWeeks}, (_, i) => i + 1);
      }
    }

    // Load weekly guidance
    async function loadWeeklyGuidance() {
      if (!currentCrop) return;
      
      try {
        // Update week display
        const weekPosition = currentWeekIndex + 1;
        const totalAvailableWeeks = availableWeeks.length;
        document.getElementById('weekTitle').textContent = `Week ${currentWeek} (${weekPosition} of ${totalAvailableWeeks})`;
        document.getElementById('weekSubtitle').textContent = getWeekSubtitle(currentWeek);
        
        // Load comprehensive weekly guidance
        const response = await fetch(`/api/crops/${currentCrop.crop_id}/weekly-guidance/${currentWeek}`);
        if (response.ok) {
          const guidance = await response.json();
          displayWeeklyGuidance(guidance);
        } else {
          throw new Error('Failed to load weekly guidance');
        }
        
        // Load progress for this week
        loadWeekProgress();
        
      } catch (error) {
        console.error('Error loading weekly guidance:', error);
        showError('Failed to load weekly guidance. Please try again.');
      }
    }

    // Display weekly guidance
    function displayWeeklyGuidance(guidance) {
      displayWeeklyTasks(guidance.weekly_tasks);
      displayCropStages(guidance.stages);
      displayVideos(guidance.videos);
      displayFertilizersPesticides(guidance.fertilizers, guidance.pesticides);
      
      // Load enhanced features
      loadCropTips();
      loadWeatherRecommendations();
      loadTaskDependencies();
    }

    // Display weekly tasks
    function displayWeeklyTasks(tasks) {
      const container = document.getElementById('weeklyTasks');
      
      if (tasks.length === 0) {
        container.innerHTML = '<div class="no-data">No specific tasks for this week. Continue with general maintenance.</div>';
        return;
      }
      
      container.innerHTML = tasks.map(task => {
        const priorityClass = `priority-${task.priority.toLowerCase()}`;
        return `
          <div class="task-item" data-task-id="${task.id}">
            <div class="task-header">
              <div class="task-title">${task.task_title}</div>
              <div class="task-priority ${priorityClass}">${task.priority}</div>
            </div>
            
            <div class="task-description">${task.task_description}</div>
            
            <div class="task-details">
              <div class="detail-item">
                <div class="detail-label">Duration</div>
                <div class="detail-value">${task.estimated_duration || 'Not specified'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Type</div>
                <div class="detail-value">${task.task_type}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Equipment</div>
                <div class="detail-value">${task.equipment_needed || 'None'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Materials</div>
                <div class="detail-value">${task.materials_needed || 'None'}</div>
              </div>
            </div>
            
            ${task.step_by_step_instructions ? `
              <div class="instructions">
                <h4>üìù Step-by-Step Instructions</h4>
                <ol>${task.step_by_step_instructions.split('\n').map(step => `<li>${step}</li>`).join('')}</ol>
              </div>
            ` : ''}
            
            ${task.tips_and_notes ? `
              <div class="tips-notes">
                <h4>üí° Tips & Notes</h4>
                <p>${task.tips_and_notes}</p>
              </div>
            ` : ''}
            
            ${task.safety_precautions ? `
              <div class="safety-precautions">
                <h4>‚ö†Ô∏è Safety Precautions</h4>
                <p>${task.safety_precautions}</p>
              </div>
            ` : ''}
            
            <div class="task-actions">
              ${task.video_url ? `
                <button class="btn btn-outline-primary" onclick="playVideo('${task.video_url}', '${task.task_title}')">
                  üé• Watch Video
                </button>
              ` : ''}
              <button class="btn btn-primary" onclick="markTaskComplete(${task.id}, '${task.task_title}')">
                ‚úÖ Mark Complete
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Display crop stages
    function displayCropStages(stages) {
      const container = document.getElementById('cropStages');
      
      if (stages.length === 0) {
        container.innerHTML = '<div class="no-data">No specific stages for this week.</div>';
        return;
      }
      
      container.innerHTML = stages.map(stage => `
        <div class="task-item">
          <div class="task-header">
            <div class="task-title">${stage.title}</div>
            <div class="task-priority priority-medium">${stage.difficulty_level || 'Medium'}</div>
          </div>
          
          <div class="task-description">${stage.detailed_description || stage.tasks}</div>
          
          <div class="task-details">
            <div class="detail-item">
              <div class="detail-label">Duration</div>
              <div class="detail-value">${stage.time_required || 'Not specified'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Equipment</div>
              <div class="detail-value">${stage.equipment_needed || 'None'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Weeks</div>
              <div class="detail-value">${stage.start_week}-${stage.end_week}</div>
            </div>
          </div>
          
          ${stage.video_url ? `
            <div class="task-actions">
              <button class="btn btn-outline-primary" onclick="playVideo('${stage.video_url}', '${stage.title}')">
                üé• Watch Video
              </button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    // Display videos
    function displayVideos(videos) {
      let container = document.getElementById('videoList');
      
      // Create the container if it doesn't exist
      if (!container) {
        const videosSection = document.querySelector('.videos-section');
        if (!videosSection) return; // If there's no section to add videos to, exit
        
        container = document.createElement('div');
        container.id = 'videoList';
        container.className = 'video-list';
        videosSection.appendChild(container);
      }
      
      if (!videos || !Array.isArray(videos) || videos.length === 0) {
        container.innerHTML = '<div class="no-data">No videos available for this week.</div>';
        return;
      }
      
      container.innerHTML = videos.map(video => {
        if (!video || !video.video_url) return '';
        
        // Extract YouTube video ID from URL
        let videoId = '';
        const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
        const match = video.video_url.match(youtubeRegex);
        if (match && match[1]) {
          videoId = match[1];
        }
        
        // Create thumbnail URL if not provided
        let thumbnailUrl = video.thumbnail_url;
        if (!thumbnailUrl && videoId) {
          thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
        }
        
        const title = video.video_title || 'Untitled Video';
        const description = video.description || '';
        const duration = video.duration_minutes ? `${video.duration_minutes} min` : '';
        const type = video.video_type || 'Video';
        const isFeatured = video.is_featured ? 'Featured' : 'Regular';
        
        return `
          <div class="video-item" onclick="playVideo('${video.video_url.replace(/'/g, "\\'")}', '${title.replace(/'/g, "\\'")}')">
            <div class="video-thumbnail">
              ${thumbnailUrl ? 
                `<img src="${thumbnailUrl}" alt="${title}" onerror="this.onerror=null; this.parentElement.innerHTML='‚ñ∂Ô∏è';">` : 
                '<div class="video-placeholder">‚ñ∂Ô∏è</div>'
              }
            </div>
            <div class="video-info">
              <div class="video-title">${title}</div>
              <div class="video-meta">
                ${duration ? `${duration} ‚Ä¢ ` : ''}
                ${type} ‚Ä¢ 
                ${isFeatured}
              </div>
              ${description ? `<div class="video-description">${description}</div>` : ''}
            </div>
          </div>
        `;
      }).filter(Boolean).join('');
    }

    // Display fertilizers and pesticides
    function displayFertilizersPesticides(fertilizers, pesticides) {
      const container = document.getElementById('fertilizersPesticides');
      
      let content = '';
      
      if (fertilizers.length > 0) {
        content += '<h4>üåø Fertilizers</h4>';
        content += fertilizers.map(f => `
          <div class="task-item">
            <div class="task-title">${f.name}</div>
            <div class="task-details">
              <div class="detail-item">
                <div class="detail-label">Quantity</div>
                <div class="detail-value">${f.quantity}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Price</div>
                <div class="detail-value">${f.price}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Gap Days</div>
                <div class="detail-value">${f.gap_days || 'N/A'}</div>
              </div>
            </div>
          </div>
        `).join('');
      }
      
      if (pesticides.length > 0) {
        content += '<h4>üõ°Ô∏è Pesticides</h4>';
        content += pesticides.map(p => `
          <div class="task-item">
            <div class="task-title">${p.name}</div>
            <div class="task-details">
              <div class="detail-item">
                <div class="detail-label">Application</div>
                <div class="detail-value">${p.application}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Quantity</div>
                <div class="detail-value">${p.quantity}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Price</div>
                <div class="detail-value">${p.price}</div>
              </div>
            </div>
          </div>
        `).join('');
      }
      
      if (content === '') {
        content = '<div class="no-data">No fertilizers or pesticides for this week.</div>';
      }
      
      container.innerHTML = content;
    }

    // Load week progress
    async function loadWeekProgress() {
      if (!currentSessionId) return;
      
      try {
        const response = await fetch(`/api/crop-progress/${currentSessionId}/week/${currentWeek}`);
        if (response.ok) {
          const progress = await response.json();
          displayProgressSummary(progress.progress_summary);
        }
      } catch (error) {
        console.error('Error loading progress:', error);
      }
    }

    // Display progress summary
    function displayProgressSummary(summary) {
      const container = document.getElementById('progressSummary');
      
      const completionPercentage = summary.total_tasks > 0 ? 
        Math.round((summary.completed_tasks / summary.total_tasks) * 100) : 0;
      
      container.innerHTML = `
        <h3>Week ${currentWeek} Progress</h3>
        <div class="progress-stats">
          <div class="stat-item">
            <div class="stat-number">${summary.completed_tasks}</div>
            <div class="stat-label">Completed</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">${summary.in_progress_tasks}</div>
            <div class="stat-label">In Progress</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">${summary.not_started_tasks}</div>
            <div class="stat-label">Not Started</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">${completionPercentage}%</div>
            <div class="stat-label">Complete</div>
          </div>
        </div>
      `;
    }

    // Play video
    function playVideo(videoUrl, title) {
      document.getElementById('videoModalTitle').textContent = title;
      document.getElementById('videoContainer').innerHTML = `
        <iframe src="${videoUrl}" frameborder="0" allowfullscreen></iframe>
      `;
      document.getElementById('videoModal').style.display = 'block';
    }

    // Close video modal
    function closeVideoModal() {
      document.getElementById('videoModal').style.display = 'none';
      document.getElementById('videoContainer').innerHTML = '';
    }

    // Mark task as complete
    async function markTaskComplete(taskId, taskTitle) {
      try {
        const response = await fetch(`/api/crop-progress/${currentSessionId}/task/${taskId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            completion_status: 'completed',
            notes: `Task completed: ${taskTitle}`,
            rating: 5
          })
        });
        
        if (response.ok) {
          showSuccess('Task marked as complete!');
          loadWeekProgress();
          // Reload the current week to update task status
          loadWeeklyGuidance();
        } else {
          throw new Error('Failed to update task');
        }
      } catch (error) {
        console.error('Error updating task:', error);
        showError('Failed to update task. Please try again.');
      }
    }

    // Navigation functions
    function goToPreviousWeek() {
      if (currentWeekIndex > 0) {
        currentWeekIndex--;
        currentWeek = availableWeeks[currentWeekIndex];
        loadWeeklyGuidance();
      }
    }

    function goToNextWeek() {
      if (currentWeekIndex < availableWeeks.length - 1) {
        currentWeekIndex++;
        currentWeek = availableWeeks[currentWeekIndex];
        loadWeeklyGuidance();
      }
    }

    function jumpToWeek() {
      const availableWeeksStr = availableWeeks.join(', ');
      const week = prompt(`Available weeks with tasks: ${availableWeeksStr}\n\nEnter week number:`, currentWeek);
      const weekNum = parseInt(week);
      
      if (weekNum && availableWeeks.includes(weekNum)) {
        currentWeekIndex = availableWeeks.indexOf(weekNum);
        currentWeek = weekNum;
        loadWeeklyGuidance();
      } else if (weekNum) {
        alert(`Week ${weekNum} has no tasks. Available weeks: ${availableWeeksStr}`);
      }
    }

    // Get week subtitle
    function getWeekSubtitle(week) {
      const subtitles = {
        1: 'Nursery Preparation',
        2: 'Seeding and Initial Care',
        3: 'Seedling Care and First Fertilization',
        4: 'Transplanting Preparation',
        5: 'Transplanting',
        6: 'Post-Transplant Care',
        7: 'Vegetative Growth Management',
        8: 'Flowering Stage Preparation',
        9: 'Flowering and Fruit Set',
        10: 'Fruit Development',
        11: 'Pre-Harvest Preparation',
        12: 'Harvesting'
      };
      return subtitles[week] || 'Growth and Development';
    }

    // Utility functions
    function showSuccess(message) {
      // Simple success notification
      alert('‚úÖ ' + message);
    }

    function showError(message) {
      // Simple error notification
      alert('‚ùå ' + message);
    }

    // Logout function
    async function logoutAndRefresh() {
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = '/login.html';
    }

    // Event listeners
    document.getElementById('prevWeekBtn').addEventListener('click', goToPreviousWeek);
    document.getElementById('nextWeekBtn').addEventListener('click', goToNextWeek);
    document.getElementById('jumpToWeekBtn').addEventListener('click', jumpToWeek);

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('videoModal');
      if (event.target === modal) {
        closeVideoModal();
      }
    });

    // Initialize the application
    async function initializeApp() {
      const isAuthenticated = await ensureAuth();
      if (isAuthenticated) {
        await loadActiveCrops();
      }
    }

    // Mock data for development
    const mockData = {
      tips: [
        "Ensure proper spacing between plants for better air circulation.",
        "Water the plants early in the morning to prevent fungal growth.",
        "Monitor for common pests like aphids and caterpillars.",
        "Use organic compost to enrich the soil nutrients.",
        "Prune any dead or diseased leaves regularly."
      ],
      weather: {
        temperature: '22-28¬∞C',
        humidity: '60-70%',
        rainfall: 'Medium',
        recommendations: [
          'Light irrigation recommended in the morning',
          'Apply mulch to retain soil moisture',
          'Monitor for signs of heat stress'
        ]
      },
      dependencies: [
        { task: 'Soil Preparation', dependsOn: ['Clear Land'], status: 'completed' },
        { task: 'Planting', dependsOn: ['Soil Preparation', 'Fertilizer Application'], status: 'pending' },
        { task: 'First Weeding', dependsOn: ['Planting'], status: 'pending' }
      ]
    };

    // Enhanced features functions with fallback to mock data
    async function loadWithFallback(url, mockDataKey) {
      try {
        const response = await fetch(url);
        if (response.ok) {
          return await response.json();
        }
        throw new Error(`HTTP error! status: ${response.status}`);
      } catch (error) {
        console.warn(`Using mock data for ${url}:`, error.message);
        return mockData[mockDataKey];
      }
    }

    async function loadCropTips() {
      if (!currentCrop) return;
      
      try {
        const tips = await loadWithFallback(
          `/api/crops/${currentCrop.crop_id}/tips?week=${currentWeek}`, 
          'tips'
        );
        displayCropTips(tips);
      } catch (error) {
        console.error('Error in loadCropTips:', error);
        displayCropTips(mockData.tips);
      }
    }
    
    async function loadWeatherRecommendations() {
      if (!currentCrop) return;
      
      try {
        const weather = await loadWithFallback(
          `/api/crops/${currentCrop.crop_id}/weather-recommendations?week=${currentWeek}`,
          'weather'
        );
        displayWeatherRecommendations(weather);
      } catch (error) {
        console.error('Error in loadWeatherRecommendations:', error);
        displayWeatherRecommendations(mockData.weather);
      }
    }
    
    async function loadTaskDependencies() {
      if (!currentCrop) return;
      
      try {
        const dependencies = await loadWithFallback(
          `/api/crops/${currentCrop.crop_id}/task-dependencies?week=${currentWeek}`,
          'dependencies'
        );
        displayTaskDependencies(dependencies);
      } catch (error) {
        console.error('Error in loadTaskDependencies:', error);
        displayTaskDependencies(mockData.dependencies);
      }
    }
    
    function displayCropTips(tips) {
      const container = document.getElementById('tipsContent');
      const section = document.getElementById('tipsSection');
      
      if (!tips || (Array.isArray(tips) && tips.length === 0)) {
        container.innerHTML = '<div class="no-data">No tips available for this week.</div>';
        if (section) section.style.display = 'none';
        return;
      }
      
      let html = '<ul class="tips-list" style="margin: 0; padding-left: 1.25rem;">';
      const tipsList = Array.isArray(tips) ? tips : [tips];
      
      tipsList.forEach(tip => {
        if (tip) {
          html += `<li style="margin-bottom: 0.5rem;">${tip}</li>`;
        }
      });
      html += '</ul>';
      
      container.innerHTML = html;
      if (section) section.style.display = 'block';
    }
    
    function displayWeatherRecommendations(weather) {
      const container = document.getElementById('weatherContent');
      const section = document.getElementById('weatherSection');
      
      if (!weather || (typeof weather === 'object' && Object.keys(weather).length === 0)) {
        container.innerHTML = '<div class="no-data">No weather data available at the moment.</div>';
        if (section) section.style.display = 'none';
        return;
      }
      
      // Handle case where weather is a string or has a message property
      if (typeof weather === 'string' || weather.message) {
        container.innerHTML = `<div class="weather-info">
          <p>${weather.message || weather}</p>
        </div>`;
        if (section) section.style.display = 'block';
        return;
      }
      
      let html = `
        <div class="weather-info">
          <div class="weather-item">
            <span class="weather-label"> Temperature:</span>
            <span class="weather-value">${weather.temperature || 'N/A'}</span>
          </div>
          <div class="weather-item">
            <span class="weather-label"> Humidity:</span>
            <span class="weather-value">${weather.humidity || 'N/A'}</span>
          </div>
          <div class="weather-item">
            <span class="weather-label"> Rainfall:</span>
            <span class="weather-value">${weather.rainfall || 'N/A'}</span>
          </div>
      `;
      
      if (weather.recommendations && Array.isArray(weather.recommendations) && weather.recommendations.length > 0) {
        html += '<div class="mt-3"><strong> Recommendations:</strong><ul class="recommendations-list">';
        weather.recommendations.forEach(rec => {
          if (rec) html += `<li>${rec}</li>`;
        });
        html += '</ul></div>';
      }
      
      html += '</div>';
      container.innerHTML = html;
      if (section) section.style.display = 'block';
    }
    
    function displayTaskDependencies(dependencies) {
      const container = document.getElementById('dependenciesContent');
      const section = document.getElementById('dependenciesSection');
      
      if (!dependencies || (Array.isArray(dependencies) && dependencies.length === 0)) {
        container.innerHTML = '<div class="no-data">No task dependencies available for this week.</div>';
        if (section) section.style.display = 'none';
        return;
      }
      
      let html = '<ul class="dependencies-list" style="margin: 0; padding-left: 1.25rem;">';
      
      dependencies.forEach(dep => {
        if (dep) {
          html += `<li style="margin-bottom: 0.5rem;">${dep.task} depends on ${dep.dependsOn}</li>`;
        }
      });
      html += '</ul>';
      
      container.innerHTML = html;
      if (section) section.style.display = 'block';
    }
    
    // Enhanced video modal
    function playVideo(videoUrl, videoTitle) {
      const modal = document.getElementById('videoModal');
      const title = document.getElementById('videoModalTitle');
      const player = document.getElementById('modalVideoPlayer');
      
      title.textContent = videoTitle;
      player.src = videoUrl;
      modal.style.display = 'block';
    }
    
    function closeVideoModal() {
      const modal = document.getElementById('videoModal');
      const player = document.getElementById('modalVideoPlayer');
      
      modal.style.display = 'none';
      player.src = '';
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('videoModal');
      if (event.target === modal) {
        closeVideoModal();
      }
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
