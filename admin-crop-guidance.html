<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåæ Crop Guidance Management - Agricultural System</title>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <nav class="nav">
      <a href="/admin-dashboard.html" class="logo">üåæ Crop Guidance Management</a>
      <ul class="nav-links">
        <li><a href="/admin-dashboard.html">üè† Dashboard</a></li>
        <li><a href="#" onclick="logoutAndRefresh()">Logout</a></li>
      </ul>
    </nav>
  </header>

  <div class="admin-container">
    <!-- Admin Header -->
    <div class="admin-header">
      <h1>üåæ Crop Guidance Management</h1>
      <p>Manage crop information, stages, and comprehensive guidance</p>
    </div>

    <!-- Admin Navigation -->
    <div class="admin-nav">
      <button class="nav-btn active" onclick="showSection('overview')">üìä Overview</button>
      <button class="nav-btn" onclick="showSection('crops')">üåæ Crops</button>
      <button class="nav-btn" onclick="showSection('stages')">üå± Stages</button>
      <button class="nav-btn" onclick="showSection('guides')">üìñ Guides</button>
      <button class="nav-btn" onclick="showSection('fertilizers')">üåø Fertilizers</button>
      <button class="nav-btn" onclick="showSection('pesticides')">üêõ Pesticides</button>
    </div>

    <!-- Overview Section -->
    <div id="overview" class="content-section active">
      <div class="section-header">
        <h2 class="section-title">üìä Crop Guidance Overview</h2>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalCrops">-</div>
          <div class="stat-label">Total Crops</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalStages">-</div>
          <div class="stat-label">Crop Stages</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalGuides">-</div>
          <div class="stat-label">Crop Guides</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalFertilizers">-</div>
          <div class="stat-label">Fertilizer Records</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalPesticides">-</div>
          <div class="stat-label">Pesticide Records</div>
        </div>
      </div>
      
      <div id="overviewContent">
        <div class="loading">Loading overview data...</div>
      </div>
    </div>

    <!-- Crops Section -->
    <div id="crops" class="content-section">
      <div class="section-header">
        <h2 class="section-title">üåæ Crop Management</h2>
        <button class="btn btn-primary" onclick="showAddCropModal()">Add New Crop</button>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Search Crops</label>
          <input type="text" id="cropSearch" class="form-control" placeholder="Search by name or category...">
        </div>
        <div class="form-group">
          <label class="form-label">Filter by Category</label>
          <select id="categoryFilter" class="form-control">
            <option value="">All Categories</option>
          </select>
        </div>
      </div>
      
      <div id="cropsContent">
        <div class="loading">Loading crops...</div>
      </div>
    </div>

    <!-- Stages Section -->
    <div id="stages" class="content-section">
      <div class="section-header">
        <h2 class="section-title">üå± Crop Stages Management</h2>
        <button class="btn btn-primary" onclick="showAddStageModal()">Add New Stage</button>
      </div>
      
      <div id="stagesContent">
        <div class="loading">Loading crop stages...</div>
      </div>
    </div>

    <!-- Guides Section -->
    <div id="guides" class="content-section">
      <div class="section-header">
        <h2 class="section-title">üìñ Crop Guides Management</h2>
        <button class="btn btn-primary" onclick="showAddGuideModal()">Add New Guide</button>
      </div>
      
      <div id="guidesContent">
        <div class="loading">Loading crop guides...</div>
      </div>
    </div>

    <!-- Fertilizers Section -->
    <div id="fertilizers" class="content-section">
      <div class="section-header">
        <h2 class="section-title">üåø Fertilizer Management</h2>
        <button class="btn btn-primary" onclick="showAddFertilizerModal()">Add New Fertilizer</button>
      </div>
      
      <div id="fertilizersContent">
        <div class="loading">Loading fertilizers...</div>
      </div>
    </div>

    <!-- Pesticides Section -->
    <div id="pesticides" class="content-section">
      <div class="section-header">
        <h2 class="section-title">üêõ Pesticide Management</h2>
        <button class="btn btn-primary" onclick="showAddPesticideModal()">Add New Pesticide</button>
      </div>
      
      <div id="pesticidesContent">
        <div class="loading">Loading pesticides...</div>
      </div>
    </div>
  </div>

  <!-- Add Crop Modal -->
  <div id="addCropModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add New Crop</h3>
        <span class="modal-close" onclick="closeAddCropModal()">&times;</span>
      </div>
      <form id="addCropForm">
        <div class="form-group">
          <label class="form-label">Crop Name</label>
          <input type="text" id="cropName" class="form-control" required>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Season</label>
            <input type="text" id="cropSeason" class="form-control" placeholder="e.g., Kharif, Rabi">
          </div>
          <div class="form-group">
            <label class="form-label">Crop Category</label>
            <input type="text" id="cropCategory" class="form-control" placeholder="e.g., Cereals, Vegetables">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">EC Range</label>
            <input type="text" id="cropEC" class="form-control" placeholder="e.g., 1.5-2.5">
          </div>
          <div class="form-group">
            <label class="form-label">Soil Types</label>
            <input type="text" id="cropSoilTypes" class="form-control" placeholder="e.g., Clay, Loam, Sandy">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Min Land Size (acres)</label>
            <input type="number" id="cropLandSizeMin" class="form-control" step="0.1">
          </div>
          <div class="form-group">
            <label class="form-label">Max Land Size (acres)</label>
            <input type="number" id="cropLandSizeMax" class="form-control" step="0.1">
          </div>
        </div>
        
        <div class="form-group">
          <button type="submit" class="btn btn-primary">Add Crop</button>
          <button type="button" class="btn btn-warning" onclick="closeAddCropModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentUser = null;
    let allCrops = [];
    let allStages = [];
    let allGuides = [];
    let allFertilizers = [];
    let allPesticides = [];

    // Check authentication
    async function ensureAuth() {
      try {
        const response = await fetch('/api/me');
        const me = await response.json();
        if (!me.authenticated) {
          alert('Please login to access admin panel.');
          window.location.href = '/login.html';
          return false;
        }
        if (!me.is_admin) {
          alert('Admin access required.');
          window.location.href = '/index.html';
          return false;
        }
        currentUser = me;
        return true;
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/login.html';
        return false;
      }
    }

    // Show section
    function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(sectionId).classList.add('active');
      event.target.classList.add('active');
      
      // Load section data
      loadSectionData(sectionId);
    }

    // Load section data
    async function loadSectionData(sectionId) {
      switch(sectionId) {
        case 'overview':
          await loadOverview();
          break;
        case 'crops':
          await loadCrops();
          break;
        case 'stages':
          await loadStages();
          break;
        case 'guides':
          await loadGuides();
          break;
        case 'fertilizers':
          await loadFertilizers();
          break;
        case 'pesticides':
          await loadPesticides();
          break;
      }
    }

    // Load overview data
    async function loadOverview() {
      try {
        const [cropsRes, stagesRes, guidesRes, fertilizersRes, pesticidesRes] = await Promise.all([
          fetch('/api/crops'),
          fetch('/api/admin/crop_stages'),
          fetch('/api/admin/crop_guides'),
          fetch('/api/admin/fertilizers'),
          fetch('/api/admin/pesticides')
        ]);
        
        allCrops = await cropsRes.json();
        allStages = await stagesRes.json();
        allGuides = await guidesRes.json();
        allFertilizers = await fertilizersRes.json();
        allPesticides = await pesticidesRes.json();
        
        // Update stats
        document.getElementById('totalCrops').textContent = allCrops.length;
        document.getElementById('totalStages').textContent = allStages.length;
        document.getElementById('totalGuides').textContent = allGuides.length;
        document.getElementById('totalFertilizers').textContent = allFertilizers.length;
        document.getElementById('totalPesticides').textContent = allPesticides.length;
        
        // Load recent crops
        loadRecentCrops();
        
      } catch (error) {
        console.error('Error loading overview:', error);
        document.getElementById('overviewContent').innerHTML = '<div class="error">Error loading overview data</div>';
      }
    }

    // Load recent crops
    function loadRecentCrops() {
      const container = document.getElementById('overviewContent');
      const recentCrops = allCrops.slice(0, 6);
      
      container.innerHTML = `
        <h3>Recent Crops</h3>
        <div class="crop-grid">
          ${recentCrops.map(crop => `
            <div class="crop-card">
              <div class="crop-header">
                <div class="crop-icon">üåæ</div>
                <div class="crop-info">
                  <div class="crop-name">${crop.name}</div>
                  <div class="crop-category">${crop.crop_category || 'No category'}</div>
                </div>
              </div>
              
              <div class="crop-details">
                <div class="detail-item">
                  <span class="detail-label">Season:</span>
                  <span class="detail-value">${crop.season || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">EC Range:</span>
                  <span class="detail-value">${crop.ec || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Land Size:</span>
                  <span class="detail-value">${crop.land_size_min ? `${crop.land_size_min}-${crop.land_size_max || '‚àû'} acres` : 'N/A'}</span>
                </div>
              </div>
              
              <div class="crop-actions">
                <button class="btn btn-primary btn-sm" onclick="editCrop(${crop.id})">Edit</button>
                <button class="btn btn-success btn-sm" onclick="viewCropDetails(${crop.id})">View</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCrop(${crop.id})">Delete</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Load crops
    async function loadCrops() {
      try {
        const response = await fetch('/api/crops');
        const crops = await response.json();
        
        allCrops = crops;
        displayCrops(crops);
        populateCategoryFilter();
        
      } catch (error) {
        console.error('Error loading crops:', error);
        document.getElementById('cropsContent').innerHTML = '<div class="error">Error loading crops</div>';
      }
    }

    // Display crops
    function displayCrops(crops) {
      const container = document.getElementById('cropsContent');
      container.innerHTML = `
        <div class="crop-grid">
          ${crops.map(crop => `
            <div class="crop-card">
              <div class="crop-header">
                <div class="crop-icon">üåæ</div>
                <div class="crop-info">
                  <div class="crop-name">${crop.name}</div>
                  <div class="crop-category">${crop.crop_category || 'No category'}</div>
                </div>
              </div>
              
              <div class="crop-details">
                <div class="detail-item">
                  <span class="detail-label">Season:</span>
                  <span class="detail-value">${crop.season || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">EC Range:</span>
                  <span class="detail-value">${crop.ec || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Land Size:</span>
                  <span class="detail-value">${crop.land_size_min ? `${crop.land_size_min}-${crop.land_size_max || '‚àû'} acres` : 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Soil Types:</span>
                  <span class="detail-value">${crop.soil_types || 'N/A'}</span>
                </div>
              </div>
              
              <div class="crop-actions">
                <button class="btn btn-primary btn-sm" onclick="editCrop(${crop.id})">Edit</button>
                <button class="btn btn-success btn-sm" onclick="viewCropDetails(${crop.id})">View</button>
                <button class="btn btn-warning btn-sm" onclick="manageCropStages(${crop.id})">Stages</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCrop(${crop.id})">Delete</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Populate category filter
    function populateCategoryFilter() {
      const categoryFilter = document.getElementById('categoryFilter');
      const categories = [...new Set(allCrops.map(crop => crop.crop_category).filter(Boolean))];
      
      categoryFilter.innerHTML = '<option value="">All Categories</option>' + 
        categories.map(category => `<option value="${category}">${category}</option>`).join('');
    }

    // Load stages
    async function loadStages() {
      try {
        const response = await fetch('/api/admin/crop_stages');
        const stages = await response.json();
        
        allStages = stages;
        displayStages(stages);
        
      } catch (error) {
        console.error('Error loading stages:', error);
        document.getElementById('stagesContent').innerHTML = '<div class="error">Error loading crop stages</div>';
      }
    }

    // Display stages
    function displayStages(stages) {
      const container = document.getElementById('stagesContent');
      container.innerHTML = `
        <div class="stage-timeline">
          <h3>Crop Stages Timeline</h3>
          ${stages.map(stage => `
            <div class="stage-item">
              <div class="stage-icon">üå±</div>
              <div class="stage-content">
                <div class="stage-title">${stage.title}</div>
                <div class="stage-weeks">Stage ${stage.stage_number} - Weeks ${stage.start_week} to ${stage.end_week}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Load guides
    async function loadGuides() {
      try {
        const response = await fetch('/api/admin/crop_guides');
        const guides = await response.json();
        
        allGuides = guides;
        displayGuides(guides);
        
      } catch (error) {
        console.error('Error loading guides:', error);
        document.getElementById('guidesContent').innerHTML = '<div class="error">Error loading crop guides</div>';
      }
    }

    // Display guides
    function displayGuides(guides) {
      const container = document.getElementById('guidesContent');
      container.innerHTML = `
        <div class="crop-grid">
          ${guides.map(guide => `
            <div class="crop-card">
              <div class="crop-header">
                <div class="crop-icon">üìñ</div>
                <div class="crop-info">
                  <div class="crop-name">Crop Guide</div>
                  <div class="crop-category">Crop ID: ${guide.crop_id}</div>
                </div>
              </div>
              
              <div class="crop-details">
                <div class="detail-item">
                  <span class="detail-label">Overview:</span>
                  <span class="detail-value">${guide.overview ? guide.overview.substring(0, 50) + '...' : 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Climate:</span>
                  <span class="detail-value">${guide.climate ? guide.climate.substring(0, 50) + '...' : 'N/A'}</span>
                </div>
              </div>
              
              <div class="crop-actions">
                <button class="btn btn-primary btn-sm" onclick="editGuide(${guide.id})">Edit</button>
                <button class="btn btn-success btn-sm" onclick="viewGuide(${guide.id})">View</button>
                <button class="btn btn-danger btn-sm" onclick="deleteGuide(${guide.id})">Delete</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Load fertilizers
    async function loadFertilizers() {
      try {
        const response = await fetch('/api/admin/fertilizers');
        const fertilizers = await response.json();
        
        allFertilizers = fertilizers;
        displayFertilizers(fertilizers);
        
      } catch (error) {
        console.error('Error loading fertilizers:', error);
        document.getElementById('fertilizersContent').innerHTML = '<div class="error">Error loading fertilizers</div>';
      }
    }

    // Display fertilizers
    function displayFertilizers(fertilizers) {
      const container = document.getElementById('fertilizersContent');
      container.innerHTML = `
        <div class="crop-grid">
          ${fertilizers.map(fertilizer => `
            <div class="crop-card">
              <div class="crop-header">
                <div class="crop-icon">üåø</div>
                <div class="crop-info">
                  <div class="crop-name">${fertilizer.name}</div>
                  <div class="crop-category">Week ${fertilizer.week || 'N/A'}</div>
                </div>
              </div>
              
              <div class="crop-details">
                <div class="detail-item">
                  <span class="detail-label">Quantity:</span>
                  <span class="detail-value">${fertilizer.quantity || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Price:</span>
                  <span class="detail-value">${fertilizer.price || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Gap Days:</span>
                  <span class="detail-value">${fertilizer.gap_days || 'N/A'}</span>
                </div>
              </div>
              
              <div class="crop-actions">
                <button class="btn btn-primary btn-sm" onclick="editFertilizer(${fertilizer.id})">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteFertilizer(${fertilizer.id})">Delete</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Load pesticides
    async function loadPesticides() {
      try {
        const response = await fetch('/api/admin/pesticides');
        const pesticides = await response.json();
        
        allPesticides = pesticides;
        displayPesticides(pesticides);
        
      } catch (error) {
        console.error('Error loading pesticides:', error);
        document.getElementById('pesticidesContent').innerHTML = '<div class="error">Error loading pesticides</div>';
      }
    }

    // Display pesticides
    function displayPesticides(pesticides) {
      const container = document.getElementById('pesticidesContent');
      container.innerHTML = `
        <div class="crop-grid">
          ${pesticides.map(pesticide => `
            <div class="crop-card">
              <div class="crop-header">
                <div class="crop-icon">üêõ</div>
                <div class="crop-info">
                  <div class="crop-name">${pesticide.name}</div>
                  <div class="crop-category">Week ${pesticide.week || 'N/A'}</div>
                </div>
              </div>
              
              <div class="crop-details">
                <div class="detail-item">
                  <span class="detail-label">Application:</span>
                  <span class="detail-value">${pesticide.application || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Quantity:</span>
                  <span class="detail-value">${pesticide.quantity || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Price:</span>
                  <span class="detail-value">${pesticide.price || 'N/A'}</span>
                </div>
              </div>
              
              <div class="crop-actions">
                <button class="btn btn-primary btn-sm" onclick="editPesticide(${pesticide.id})">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deletePesticide(${pesticide.id})">Delete</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Show add crop modal
    function showAddCropModal() {
      document.getElementById('addCropModal').style.display = 'block';
    }

    // Close add crop modal
    function closeAddCropModal() {
      document.getElementById('addCropModal').style.display = 'none';
      document.getElementById('addCropForm').reset();
    }

    // Add crop form submission
    document.getElementById('addCropForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        name: document.getElementById('cropName').value,
        season: document.getElementById('cropSeason').value,
        ec: document.getElementById('cropEC').value,
        land_size_min: document.getElementById('cropLandSizeMin').value || null,
        land_size_max: document.getElementById('cropLandSizeMax').value || null,
        soil_types: document.getElementById('cropSoilTypes').value,
        crop_category: document.getElementById('cropCategory').value
      };
      
      try {
        const response = await fetch('/api/admin/crops', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        if (response.ok) {
          showMessage('Crop added successfully!', 'success');
          closeAddCropModal();
          loadCrops();
        } else {
          throw new Error('Failed to add crop');
        }
      } catch (error) {
        console.error('Error adding crop:', error);
        showMessage('Error adding crop. Please try again.', 'error');
      }
    });

    // Placeholder functions for future implementation
    function editCrop(cropId) {
      showMessage('Edit crop functionality - Coming Soon!', 'info');
    }

    function viewCropDetails(cropId) {
      showMessage('View crop details functionality - Coming Soon!', 'info');
    }

    function deleteCrop(cropId) {
      if (confirm('Are you sure you want to delete this crop?')) {
        showMessage('Delete crop functionality - Coming Soon!', 'info');
      }
    }

    function manageCropStages(cropId) {
      showMessage('Manage crop stages functionality - Coming Soon!', 'info');
    }

    function showAddStageModal() {
      showMessage('Add stage functionality - Coming Soon!', 'info');
    }

    function showAddGuideModal() {
      showMessage('Add guide functionality - Coming Soon!', 'info');
    }

    function editGuide(guideId) {
      showMessage('Edit guide functionality - Coming Soon!', 'info');
    }

    function viewGuide(guideId) {
      showMessage('View guide functionality - Coming Soon!', 'info');
    }

    function deleteGuide(guideId) {
      showMessage('Delete guide functionality - Coming Soon!', 'info');
    }

    function showAddFertilizerModal() {
      showMessage('Add fertilizer functionality - Coming Soon!', 'info');
    }

    function editFertilizer(fertilizerId) {
      showMessage('Edit fertilizer functionality - Coming Soon!', 'info');
    }

    function deleteFertilizer(fertilizerId) {
      showMessage('Delete fertilizer functionality - Coming Soon!', 'info');
    }

    function showAddPesticideModal() {
      showMessage('Add pesticide functionality - Coming Soon!', 'info');
    }

    function editPesticide(pesticideId) {
      showMessage('Edit pesticide functionality - Coming Soon!', 'info');
    }

    function deletePesticide(pesticideId) {
      showMessage('Delete pesticide functionality - Coming Soon!', 'info');
    }

    // Show message
    function showMessage(message, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = type;
      messageDiv.textContent = message;
      messageDiv.style.position = 'fixed';
      messageDiv.style.top = '20px';
      messageDiv.style.right = '20px';
      messageDiv.style.zIndex = '9999';
      messageDiv.style.padding = '1rem';
      messageDiv.style.borderRadius = '8px';
      messageDiv.style.maxWidth = '300px';
      
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        document.body.removeChild(messageDiv);
      }, 3000);
    }

    // Logout function
    async function logoutAndRefresh() {
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = '/login.html';
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async function() {
      const isAuthenticated = await ensureAuth();
      if (isAuthenticated) {
        await loadOverview();
      }
    });
  </script>
</body>
</html>


